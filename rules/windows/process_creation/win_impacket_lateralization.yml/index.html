<!doctype html><html lang=en><head><meta charset=utf-8><title>Sigma Rule Browser</title><meta name=viewport content="width=device-width"><link rel=icon type=image/png sizes=32x32 href=../images/favicon.png><link rel=stylesheet href=https://unpkg.com/bulma@0.9.2/css/bulma.min.css><script src=https://kit.fontawesome.com/7dc3015a44.js crossorigin=anonymous></script></head><body><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc/>Sigma Docs</a>
<a role=button class=navbar-burger aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc/>Home</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//rules/>Rules</a><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link>Explore rules by...</a><div class=navbar-dropdown><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//tags/>Tag</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//status/>Status</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//level/>Level</a></div></div></div><div class=navbar-end><div class=navbar-item id=search class=bd-search><form action=https://bradleyjkemp.dev/sigmadoc//search><p class="control has-icons-left"><input class="input is-rounded" type=text name=query placeholder=Search>
<span class="icon is-left"><i class="fas fa-search" aria-hidden=true></i></span></p></form></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-9"><nav class=breadcrumb aria-label=breadcrumbs><ul><li><a href=https://bradleyjkemp.dev/sigmadoc/>home</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/>rules</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/>windows</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/process_creation/>process_creation</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/process_creation/win_impacket_lateralization.yml/>win_impacket_lateralization.yml</a></li></ul></nav><div class="content is-medium"><h3 class="title is-1">Impacket Lateralization Detection</h3><div class=box><div class="field is-grouped is-justify-content-center"><div class=control><div class="tags has-addons"><span class="tag is-medium is-dark">level</span>
<span class="tag is-medium is-black">critical</span></div></div><div class=control><div class="tags has-addons"><span class="tag is-medium is-dark">status</span>
<span class="tag is-medium is-danger is-light">experimental</span></div></div></div><p>Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework</p><h2 id=known-false-positives>Known false-positives</h2><ul><li>pentesters</li></ul><h2 id=references>References</h2><ul><li><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py>https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py</a></li><li><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py>https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py</a></li><li><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py>https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py</a></li><li><a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py>https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py</a></li></ul><h2 id=raw-rule>Raw rule</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>title</span>: <span style=color:#ae81ff>Impacket Lateralization Detection</span>
<span style=color:#f92672>id</span>: <span style=color:#ae81ff>10c14723-61c7-4c75-92ca-9af245723ad2</span>
<span style=color:#f92672>status</span>: <span style=color:#ae81ff>experimental</span>
<span style=color:#f92672>description</span>: <span style=color:#ae81ff>Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework</span>
<span style=color:#f92672>references</span>:
    - <span style=color:#ae81ff>https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py</span>
    - <span style=color:#ae81ff>https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py</span>
    - <span style=color:#ae81ff>https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py</span>
    - <span style=color:#ae81ff>https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py</span>
<span style=color:#f92672>author</span>: <span style=color:#ae81ff>Ecco</span>
<span style=color:#f92672>date</span>: <span style=color:#ae81ff>2019</span><span style=color:#ae81ff>/09/03</span>
<span style=color:#f92672>modified</span>: <span style=color:#ae81ff>2020</span><span style=color:#ae81ff>/09/01</span>
<span style=color:#f92672>logsource</span>:
    <span style=color:#f92672>category</span>: <span style=color:#ae81ff>process_creation</span>
    <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
<span style=color:#f92672>detection</span>:
    <span style=color:#f92672>selection_other</span>:
        <span style=color:#75715e># *** wmiexec.py </span>
        <span style=color:#75715e>#    parent is wmiprvse.exe</span>
        <span style=color:#75715e>#    examples:</span>
        <span style=color:#75715e>#       cmd.exe /Q /c whoami 1&gt; \\127.0.0.1\ADMIN$\__1567439113.54 2&gt;&amp;1</span>
        <span style=color:#75715e>#       cmd.exe /Q /c cd  1&gt; \\127.0.0.1\ADMIN$\__1567439113.54 2&gt;&amp;1</span>
        <span style=color:#75715e># *** dcomexec.py -object MMC20 </span>
        <span style=color:#75715e>#   parent is mmc.exe</span>
        <span style=color:#75715e>#   example:</span>
        <span style=color:#75715e>#       &#34;C:\Windows\System32\cmd.exe&#34; /Q /c cd  1&gt; \\127.0.0.1\ADMIN$\__1567442499.05 2&gt;&amp;1</span>
        <span style=color:#75715e># *** dcomexec.py -object ShellBrowserWindow</span>
        <span style=color:#75715e>#  runs %SystemRoot%\System32\rundll32.exe shell32.dll,SHCreateLocalServerRunDll {c08afd90-f2a1-11d1-8455-00a0c91f3880} but parent command is explorer.exe</span>
        <span style=color:#75715e>#  example:</span>
        <span style=color:#75715e>#   &#34;C:\Windows\System32\cmd.exe&#34; /Q /c cd \ 1&gt; \\127.0.0.1\ADMIN$\__1567520103.71 2&gt;&amp;1</span>
        <span style=color:#75715e># *** smbexec.py</span>
        <span style=color:#75715e>#   parent is services.exe</span>
        <span style=color:#75715e>#   example:</span>
        <span style=color:#75715e>#       C:\Windows\system32\cmd.exe /Q /c echo tasklist ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; C:\Windows\TEMP\execute.bat &amp; C:\Windows\system32\cmd.exe /Q /c C:\Windows\TEMP\execute.bat &amp; del C:\Windows\TEMP\execute.bat</span>
        <span style=color:#f92672>ParentImage</span>:
            - <span style=color:#e6db74>&#39;*\wmiprvse.exe&#39;</span>  <span style=color:#75715e># wmiexec</span>
            - <span style=color:#e6db74>&#39;*\mmc.exe&#39;</span>  <span style=color:#75715e># dcomexec MMC</span>
            - <span style=color:#e6db74>&#39;*\explorer.exe&#39;</span>  <span style=color:#75715e># dcomexec ShellBrowserWindow</span>
            - <span style=color:#e6db74>&#39;*\services.exe&#39;</span>  <span style=color:#75715e># smbexec</span>
        <span style=color:#f92672>CommandLine</span>:
            - <span style=color:#e6db74>&#39;*cmd.exe* /Q /c * \\\\127.0.0.1\\*&amp;1*&#39;</span>
    <span style=color:#f92672>selection_atexec</span>:
        <span style=color:#f92672>ParentCommandLine</span>:
            - <span style=color:#e6db74>&#39;*svchost.exe -k netsvcs&#39;</span> <span style=color:#75715e># atexec on win10 (parent is &#34;C:\Windows\system32\svchost.exe -k netsvcs&#34;)</span>
            - <span style=color:#e6db74>&#39;taskeng.exe*&#39;</span> <span style=color:#75715e># atexec on win7 (parent is &#34;taskeng.exe {AFA79333-694C-4BEE-910E-E57D9A3518F6} S-1-5-18:NT AUTHORITY\System:Service:&#34;)</span>
        <span style=color:#75715e># cmd.exe /C tasklist /m &gt; C:\Windows\Temp\bAJrYQtL.tmp 2&gt;&amp;1</span>
        <span style=color:#f92672>CommandLine</span>:
            - <span style=color:#e6db74>&#39;cmd.exe /C *Windows\\Temp\\*&amp;1&#39;</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>(1 of selection_*)</span>
<span style=color:#f92672>fields</span>:
    - <span style=color:#ae81ff>CommandLine</span>
    - <span style=color:#ae81ff>ParentCommandLine</span>
<span style=color:#f92672>tags</span>:
    - <span style=color:#ae81ff>attack.execution</span>
    - <span style=color:#ae81ff>attack.t1047</span>
    - <span style=color:#ae81ff>attack.lateral_movement</span>
    - <span style=color:#ae81ff>attack.t1175 </span> <span style=color:#75715e># an old one</span>
    - <span style=color:#ae81ff>attack.t1021.003</span>
    - <span style=color:#ae81ff>attack.t1021 </span> <span style=color:#75715e># an old one</span>
<span style=color:#f92672>falsepositives</span>:
    - <span style=color:#ae81ff>pentesters</span>
<span style=color:#f92672>level</span>: <span style=color:#ae81ff>critical</span>

</code></pre></div></div></div></div><div class="column is-3"><aside class="menu is-medium"><p class=menu-label>Rule Tags</p><div class=tags><a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.execution class="tag is-medium">attack.execution</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.t1047 class="tag is-medium">attack.t1047</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.lateral_movement class="tag is-medium">attack.lateral_movement</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.t1175 class="tag is-medium">attack.t1175</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.t1021.003 class="tag is-medium">attack.t1021.003</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.t1021 class="tag is-medium">attack.t1021</a></a></div><ul class=menu-list></ul><p class=menu-label>Similar rules</p><ul class=menu-list><li><a href=/sigmadoc/rules/windows/other/win_defender_psexec_wmi_asr.yml/>PSExec and WMI Process Creations Block</a></li><li><a href=/sigmadoc/rules/windows/process_creation/win_mmc_spawn_shell.yml/>MMC Spawning Windows Shell</a></li><li><a href=/sigmadoc/rules/windows/builtin/win_mmc20_lateral_movement.yml/>MMC20 Lateral Movement</a></li><li><a href=/sigmadoc/rules/windows/process_creation/win_susp_wmic_proc_create_rundll32.yml/>Suspicious WMI Execution Using Rundll32</a></li><li><a href=/sigmadoc/rules/windows/process_creation/win_crime_maze_ransomware.yml/>Maze Ransomware</a></li></ul></aside></div></div></div></section><footer class=footer><div class="content has-text-centered"><p>Site generated with <a href=https://github.com/bradleyjkemp/sigmadoc><strong>sigmadoc</strong></a>. The website content
is licensed <a href=https://github.com/SigmaHQ/sigma/blob/master/LICENSE.Detection.Rules.md>DRL 1.0</a>.</p></div></footer></body></html>