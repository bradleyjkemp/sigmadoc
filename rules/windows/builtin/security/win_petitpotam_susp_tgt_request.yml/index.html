<!doctype html><html lang=en><head><meta charset=utf-8><title>Sigma Rule Browser</title><meta name=viewport content="width=device-width"><link rel=icon type=image/png sizes=32x32 href=../images/favicon.png><link rel=stylesheet href=https://unpkg.com/bulma@0.9.2/css/bulma.min.css><script src=https://kit.fontawesome.com/7dc3015a44.js crossorigin=anonymous></script></head><body><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc/>Sigma Docs</a>
<a role=button class=navbar-burger aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc/>Home</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//rules/>Rules</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//configs/>Configs</a><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link>Explore rules by...</a><div class=navbar-dropdown><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//tags/>Tag</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//status/>Status</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//level/>Level</a></div></div></div><div class=navbar-end><div class=navbar-item id=search class=bd-search><form action=https://bradleyjkemp.dev/sigmadoc//search><p class="control has-icons-left"><input class="input is-rounded" type=text name=query placeholder=Search>
<span class="icon is-left"><i class="fas fa-search" aria-hidden=true></i></span></p></form></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-9"><nav class=breadcrumb aria-label=breadcrumbs><ul><li><a href=https://bradleyjkemp.dev/sigmadoc/>home</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/>rules</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/>windows</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/builtin/>builtin</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/builtin/security/>security</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/builtin/security/win_petitpotam_susp_tgt_request.yml/>win_petitpotam_susp_tgt_request.yml</a></li></ul></nav><div class="content is-medium"><h3 class="title is-1">PetitPotam Suspicious Kerberos TGT Request</h3><div class=box><div class="field is-grouped is-justify-content-center"><div class=control><div class="tags has-addons"><span class="tag is-medium is-dark">level</span>
<span class="tag is-medium is-light"></span></div></div><div class=control><div class="tags has-addons"><span class="tag is-medium is-dark">status</span>
<span class="tag is-medium is-danger is-light">experimental</span></div></div></div><p>Detect suspicious Kerberos TGT requests. Once an attacer obtains a computer certificate by abusing Active Directory Certificate Services in combination with PetitPotam, the next step would be to leverage the certificate for malicious purposes. One way of doing this is to request a Kerberos Ticket Granting Ticket using a tool like Rubeus. This request will generate a 4768 event with some unusual fields depending on the environment. This analytic will require tuning, we recommend filtering Account_Name to the Domain Controller computer accounts.</p><h2 id=known-false-positives>Known false-positives</h2><ul><li>False positives are possible if the environment is using certificates for authentication. We recommend filtering Account_Name to the Domain Controller computer accounts.</li></ul><h2 id=references>References</h2><ul><li><a href=https://github.com/topotam/PetitPotam>https://github.com/topotam/PetitPotam</a></li><li><a href=https://isc.sans.edu/forums/diary/Active+Directory+Certificate+Services+ADCS+PKI+domain+admin+vulnerability/27668/>https://isc.sans.edu/forums/diary/Active+Directory+Certificate+Services+ADCS+PKI+domain+admin+vulnerability/27668/</a></li><li><a href=https://github.com/splunk/security_content/blob/develop/detections/endpoint/petitpotam_suspicious_kerberos_tgt_request.yml>https://github.com/splunk/security_content/blob/develop/detections/endpoint/petitpotam_suspicious_kerberos_tgt_request.yml</a></li></ul><h2 id=raw-rule-edithttpsgithubcomsigmahqsigmaeditmasterruleswindowsbuiltinsecuritywin_petitpotam_susp_tgt_requestyml>Raw rule (<a href=https://github.com/SigmaHQ/sigma/edit/master/rules/windows/builtin/security/win_petitpotam_susp_tgt_request.yml>edit</a>)</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>title</span>: <span style=color:#ae81ff>PetitPotam Suspicious Kerberos TGT Request</span>
<span style=color:#f92672>id</span>: <span style=color:#ae81ff>6a53d871-682d-40b6-83e0-b7c1a6c4e3a5</span>
<span style=color:#f92672>description</span>: <span style=color:#ae81ff>Detect suspicious Kerberos TGT requests. Once an attacer obtains a computer</span>
  <span style=color:#ae81ff>certificate by abusing Active Directory Certificate Services in combination with</span>
  <span style=color:#ae81ff>PetitPotam, the next step would be to leverage the certificate for malicious purposes.</span>
  <span style=color:#ae81ff>One way of doing this is to request a Kerberos Ticket Granting Ticket using a tool</span>
  <span style=color:#ae81ff>like Rubeus. This request will generate a 4768 event with some unusual fields depending</span>
  <span style=color:#66d9ef>on</span> <span style=color:#ae81ff>the environment. This analytic will require tuning, we recommend filtering Account_Name</span>
  <span style=color:#ae81ff>to the Domain Controller computer accounts.</span>
<span style=color:#f92672>status</span>: <span style=color:#ae81ff>experimental</span>
<span style=color:#f92672>author</span>: <span style=color:#ae81ff>Mauricio Velazco, Michael Haag</span>
<span style=color:#f92672>date</span>: <span style=color:#ae81ff>2021</span><span style=color:#ae81ff>/09/02</span>
<span style=color:#f92672>modified</span>: <span style=color:#ae81ff>2021</span><span style=color:#ae81ff>/09/07</span>
<span style=color:#f92672>references</span>:
    - <span style=color:#ae81ff>https://github.com/topotam/PetitPotam</span>
    - <span style=color:#ae81ff>https://isc.sans.edu/forums/diary/Active+Directory+Certificate+Services+ADCS+PKI+domain+admin+vulnerability/27668/</span>
    - <span style=color:#ae81ff>https://github.com/splunk/security_content/blob/develop/detections/endpoint/petitpotam_suspicious_kerberos_tgt_request.yml</span>
<span style=color:#f92672>tags</span>:
    - <span style=color:#ae81ff>attack.credential_access</span>
    - <span style=color:#ae81ff>attack.t1187</span>
<span style=color:#f92672>logsource</span>:
    <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>security</span>
    <span style=color:#f92672>definition</span>: <span style=color:#e6db74>&#39;The advanced audit policy setting &#34;Account Logon &gt; Kerberos Authentication Service&#34; must be configured for Success/Failure&#39;</span>
<span style=color:#f92672>detection</span>:
    <span style=color:#f92672>selection</span>:
        <span style=color:#f92672>EventID</span>: <span style=color:#ae81ff>4768</span>
        <span style=color:#f92672>TargetUserName|endswith</span>: <span style=color:#e6db74>&#39;$&#39;</span>
        <span style=color:#f92672>CertThumbprint</span>: <span style=color:#e6db74>&#39;*&#39;</span>
    <span style=color:#f92672>filter_local</span>:
        <span style=color:#f92672>IpAddress</span>: <span style=color:#e6db74>&#39;::1&#39;</span>
    <span style=color:#f92672>filter_thumbprint</span>:
        <span style=color:#f92672>CertThumbprint</span>: <span style=color:#e6db74>&#39;&#39;</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>selection and not 1 of filter_*</span>
<span style=color:#f92672>falsepositives</span>:
    - <span style=color:#66d9ef>False</span> <span style=color:#ae81ff>positives are possible if the environment is using certificates for authentication. We recommend filtering Account_Name to the Domain Controller computer accounts.</span>
<span style=color:#f92672>level</span>: <span style=color:#ae81ff>high</span>

</code></pre></div></div></div></div><div class="column is-3"><aside class="menu is-medium"><p class=menu-label>Rule Tags</p><div class=tags><a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.credential_access class="tag is-medium">attack.credential_access</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.t1187 class="tag is-medium">attack.t1187</a></a></div><ul class=menu-list></ul><p class=menu-label>Similar rules</p><ul class=menu-list><li><a href=/sigmadoc/rules/windows/builtin/security/win_petitpotam_network_share.yml/>Possible PetitPotam Coerce Authentication Attempt</a></li><li><a href=/sigmadoc/rules/windows/process_access/proc_access_win_lsass_memdump_evasion.yml/>LSASS Access from White-Listed Processes</a></li><li><a href=/sigmadoc/rules/windows/process_access/proc_access_win_lsass_memdump_indicators.yml/>LSASS Memory Access by Tool Named Dump</a></li><li><a href=/sigmadoc/rules/windows/process_creation/proc_creation_win_susp_trolleyexpress_procdump.yml/>Process Access via TrolleyExpress Exclusion</a></li><li><a href=/sigmadoc/rules/windows/powershell/powershell_script/posh_ps_create_volume_shadow_copy.yml/>Create Volume Shadow Copy with Powershell</a></li></ul></aside></div></div></div></section><footer class=footer><div class="content has-text-centered"><p>Site generated with <a href=https://github.com/bradleyjkemp/sigmadoc><strong>sigmadoc</strong></a>. The website content
is licensed <a href=https://github.com/SigmaHQ/sigma/blob/master/LICENSE.Detection.Rules.md>DRL 1.0</a>.</p></div></footer></body></html>