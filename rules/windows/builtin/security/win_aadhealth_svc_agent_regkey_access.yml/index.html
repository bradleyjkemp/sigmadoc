<!doctype html><html lang=en><head><meta charset=utf-8><title>Sigma Rule Browser</title><meta name=viewport content="width=device-width"><link rel=icon type=image/png sizes=32x32 href=../images/favicon.png><link rel=stylesheet href=https://unpkg.com/bulma@0.9.2/css/bulma.min.css><script src=https://kit.fontawesome.com/7dc3015a44.js crossorigin=anonymous></script></head><body><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc/>Sigma Docs</a>
<a role=button class=navbar-burger aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc/>Home</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//rules/>Rules</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//configs/>Configs</a><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link>Explore rules by...</a><div class=navbar-dropdown><a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//tags/>Tag</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//status/>Status</a>
<a class=navbar-item href=https://bradleyjkemp.dev/sigmadoc//level/>Level</a></div></div></div><div class=navbar-end><div class=navbar-item id=search class=bd-search><form action=https://bradleyjkemp.dev/sigmadoc//search><p class="control has-icons-left"><input class="input is-rounded" type=text name=query placeholder=Search>
<span class="icon is-left"><i class="fas fa-search" aria-hidden=true></i></span></p></form></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-9"><nav class=breadcrumb aria-label=breadcrumbs><ul><li><a href=https://bradleyjkemp.dev/sigmadoc/>home</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/>rules</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/>windows</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/builtin/>builtin</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/builtin/security/>security</a></li><li><a href=https://bradleyjkemp.dev/sigmadoc/rules/windows/builtin/security/win_aadhealth_svc_agent_regkey_access.yml/>win_aadhealth_svc_agent_regkey_access.yml</a></li></ul></nav><div class="content is-medium"><h3 class="title is-1">Azure AD Health Service Agents Registry Keys Access</h3><div class=box><div class="field is-grouped is-justify-content-center"><div class=control><div class="tags has-addons"><span class="tag is-medium is-dark">level</span>
<span class="tag is-medium is-light"></span></div></div><div class=control><div class="tags has-addons"><span class="tag is-medium is-dark">status</span>
<span class="tag is-medium is-danger is-light">experimental</span></div></div></div><p>This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).
Information from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).
This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\SOFTWARE\Microsoft\ADHealthAgent.
Make sure you set the SACL to propagate to its sub-keys.</p><h2 id=known-false-positives>Known false-positives</h2><ul><li>Unknown</li></ul><h2 id=references>References</h2><ul><li><a href=https://o365blog.com/post/hybridhealthagent/>https://o365blog.com/post/hybridhealthagent/</a></li><li><a href=https://github.com/OTRF/Set-AuditRule/blob/master/rules/registry/aad_connect_health_service_agent.yml>https://github.com/OTRF/Set-AuditRule/blob/master/rules/registry/aad_connect_health_service_agent.yml</a></li></ul><h2 id=raw-rule-edithttpsgithubcomsigmahqsigmaeditmasterruleswindowsbuiltinsecuritywin_aadhealth_svc_agent_regkey_accessyml>Raw rule (<a href=https://github.com/SigmaHQ/sigma/edit/master/rules/windows/builtin/security/win_aadhealth_svc_agent_regkey_access.yml>edit</a>)</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>title</span>: <span style=color:#ae81ff>Azure AD Health Service Agents Registry Keys Access</span>
<span style=color:#f92672>id</span>: <span style=color:#ae81ff>1d2ab8ac-1a01-423b-9c39-001510eae8e8</span>
<span style=color:#f92672>description</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).
</span><span style=color:#e6db74>    Information from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).
</span><span style=color:#e6db74>    This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\SOFTWARE\Microsoft\ADHealthAgent.
</span><span style=color:#e6db74>    Make sure you set the SACL to propagate to its sub-keys.</span>    
<span style=color:#f92672>status</span>: <span style=color:#ae81ff>experimental</span>
<span style=color:#f92672>date</span>: <span style=color:#ae81ff>2021</span><span style=color:#ae81ff>/08/26</span>
<span style=color:#f92672>author</span>: <span style=color:#ae81ff>Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC</span>
<span style=color:#f92672>tags</span>:
    - <span style=color:#ae81ff>attack.discovery</span>
    - <span style=color:#ae81ff>attack.t1012</span>
<span style=color:#f92672>references</span>:
  - <span style=color:#ae81ff>https://o365blog.com/post/hybridhealthagent/</span>
  - <span style=color:#ae81ff>https://github.com/OTRF/Set-AuditRule/blob/master/rules/registry/aad_connect_health_service_agent.yml</span>
<span style=color:#f92672>logsource</span>:
    <span style=color:#f92672>product</span>: <span style=color:#ae81ff>windows</span>
    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>security</span>
<span style=color:#f92672>detection</span>:
    <span style=color:#f92672>selection</span>:
        <span style=color:#f92672>EventID</span>:
            - <span style=color:#ae81ff>4656</span>
            - <span style=color:#ae81ff>4663</span>
        <span style=color:#f92672>ObjectType</span>: <span style=color:#e6db74>&#39;Key&#39;</span>
        <span style=color:#f92672>ObjectName</span>: <span style=color:#e6db74>&#39;\REGISTRY\MACHINE\SOFTWARE\Microsoft\ADHealthAgent&#39;</span>
    <span style=color:#f92672>filter</span>:
        <span style=color:#f92672>ProcessName|contains</span>:
            - <span style=color:#e6db74>&#39;Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe&#39;</span>
            - <span style=color:#e6db74>&#39;Microsoft.Identity.Health.Adfs.InsightsService.exe&#39;</span>
            - <span style=color:#e6db74>&#39;Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe&#39;</span>
            - <span style=color:#e6db74>&#39;Microsoft.Identity.Health.Adfs.PshSurrogate.exe&#39;</span>
            - <span style=color:#e6db74>&#39;Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe&#39;</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>selection and not filter</span>
<span style=color:#f92672>falsepositives</span>:
    - <span style=color:#ae81ff>Unknown</span>
<span style=color:#f92672>level</span>: <span style=color:#ae81ff>medium</span>

</code></pre></div></div></div></div><div class="column is-3"><aside class="menu is-medium"><p class=menu-label>Rule Tags</p><div class=tags><a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.discovery class="tag is-medium">attack.discovery</a></a>
<a href=https://bradleyjkemp.dev/sigmadoc//tags/attack.t1012 class="tag is-medium">attack.t1012</a></a></div><ul class=menu-list></ul><p class=menu-label>Similar rules</p><ul class=menu-list><li><a href=/sigmadoc/rules/windows/builtin/security/win_aadhealth_mon_agent_regkey_access.yml/>Azure AD Health Monitoring Agent Registry Keys Access</a></li><li><a href=/sigmadoc/rules/windows/builtin/security/win_apt_wocao.yml/>Operation Wocao Activity</a></li><li><a href=/sigmadoc/rules/windows/builtin/security/win_sam_registry_hive_handle_request.yml/>SAM Registry Hive Handle Request</a></li><li><a href=/sigmadoc/rules/windows/process_creation/proc_creation_win_query_registry.yml/>Query Registry</a></li><li><a href=/sigmadoc/rules/windows/builtin/security/win_syskey_registry_access.yml/>SysKey Registry Keys Access</a></li></ul></aside></div></div></div></section><footer class=footer><div class="content has-text-centered"><p>Site generated with <a href=https://github.com/bradleyjkemp/sigmadoc><strong>sigmadoc</strong></a>. The website content
is licensed <a href=https://github.com/SigmaHQ/sigma/blob/master/LICENSE.Detection.Rules.md>DRL 1.0</a>.</p></div></footer></body></html>